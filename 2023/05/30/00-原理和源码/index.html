<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>前端原理和源码 | TomorrowLM-Web</title><meta name="author" content="LMTomorrow,120329698@qq.com"><meta name="copyright" content="LMTomorrow"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前端原理和源码"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://tomorrowlm.github.io/2023/05/30/00-%E5%8E%9F%E7%90%86%E5%92%8C%E6%BA%90%E7%A0%81/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"前端原理和源码",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-05-30 13:42:02"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom/custom.css"><link rel="stylesheet" href="/css/custom/universe.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiperstyle.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/hexo-electric-clock@1.0.6/clock.css"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"><style>#recent-posts>.recent-post-item>.recent-post-info>.article-meta-wrap>.tags:before{content:"\A";white-space:pre}#recent-posts>.recent-post-item>.recent-post-info>.article-meta-wrap>.tags>.article-meta__separator{display:none}</style><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/touxiang.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">44</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>目录</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i> <span>其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw anzhiyu-icon-music"></i> <span>音乐馆</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友情链接</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/cover_1.gif)"><nav id="nav"><span id="blog-info"><a href="/" title="TomorrowLM-Web"><span class="site-name">TomorrowLM-Web</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>目录</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i> <span>留言板</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i> <span>其他</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw anzhiyu-icon-music"></i> <span>音乐馆</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友情链接</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">前端原理和源码</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-05-30T03:39:46.239Z" title="发表于 2023-05-30 11:39:46">2023-05-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-05-30T05:42:02.301Z" title="更新于 2023-05-30 13:42:02">2023-05-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">20k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>75分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="前端原理和源码"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h1><h2 id="webpack执⾏流程"><a href="#webpack执⾏流程" class="headerlink" title="webpack执⾏流程"></a>webpack执⾏流程</h2><h3 id="简略流程"><a href="#简略流程" class="headerlink" title="简略流程"></a>简略流程</h3><img src="img/常识/image-20220909135015955.png" alt="image-20220909135015955" style="zoom:50%"><p>图示流程理解分析：</p><ol><li><p>读取⼊⼝⽂件；</p></li><li><p>基于 AST（抽象语法树） 分析⼊⼝⽂件，并产出依赖列表；</p></li><li><p>AST （Abstract Syntax Tree）抽象语法树 在计算机科学中，或简称语法树（Syntax tree），是源代码语法结构的⼀种抽象表示。它以树状的形式表现编程语⾔的语法结构，树上的每个节点都表示源代码中的⼀种结构。</p></li><li><p>使⽤ Babel 将相关模块编译到 ES5；</p></li><li><p>webpack有⼀个智能解析器（各种babel），⼏乎可以处理任何第三⽅库。⽆论它们的模块形式是CommonJS、AMD还是普通的JS⽂件；甚⾄在加载依赖的时候，允许使⽤动态表require(“、/templates/“+name+”、jade”)。以下这些⼯具底层依赖了不同的解析器⽣成AST，⽐如eslint使⽤了espree、babel使⽤了acorn</p></li><li><p>对每个依赖模块产出⼀个唯⼀的 ID，⽅便后续读取模块相关内容；</p></li><li><p>将每个依赖以及经过 Babel 编译过后的内容，存储在⼀个对象中进⾏维护；</p></li><li><p>遍历上⼀步中的对象，构建出⼀个依赖图（Dependency Graph）；</p></li><li><p>将各模块内容 bundle 产出</p></li></ol><h3 id="详细流程"><a href="#详细流程" class="headerlink" title="详细流程"></a>详细流程</h3><img src="http://blog.51weblove.com/wp-content/uploads/2021/10/webpack%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F-scaled.jpg" alt="img" style="zoom:150%"><p>流程：</p><ol><li>通过命令行和 <code>webpack.config.js</code> 来获取参数</li><li>创建<code>compiler</code>对象，初始化<code>plugins</code></li><li>开始编译阶段，<code>addEntry</code>添加入口资源</li><li><code>addModule</code> 创建模块</li><li><code>runLoaders</code> 执行 <code>loader</code></li><li>依赖收集，js 通过<code>acorn</code>解析为 <code>AST</code>，然后查找依赖，并重复 4 步</li><li>构建完<strong>依赖树</strong>后，进入生成阶段，调用<code>compilation.seal</code></li><li>经过一系列的<code>optimize</code>优化依赖，生成 <code>chunks</code>，写入文件</li></ol><h2 id="打包原理"><a href="#打包原理" class="headerlink" title="打包原理"></a>打包原理</h2><p>⼿写webpack原理 <a target="_blank" rel="noopener" href="https://juejin.cn/post/6854573217336541192">https://juejin.cn/post/6854573217336541192</a></p><p>webpack打包原理 <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41319237/article/details/116194091">https://blog.csdn.net/weixin_41319237/article/details/116194091</a></p><p><strong>主要流程</strong></p><ol><li>需要读到入口文件里面的内容</li><li>分析入口文件，递归的去读取模块所依赖的文件内容，生成AST语法树。</li><li>根据AST语法树，生成浏览器能够运行的代码</li></ol><p><strong>具体细节</strong></p><ol><li>获取主模块内容</li><li>分析模块<ul><li>安装@babel/parser包（生成AST）</li></ul></li><li>对模块内容进行处理<ul><li>安装@babel/traverse包（遍历AST收集依赖）</li><li>安装@babel/core和@babel/preset-env包 （es6转ES5）</li></ul></li><li>递归所有模块</li><li>执行require和exports。生成最终代码</li></ol><h3 id="基本准备工作"><a href="#基本准备工作" class="headerlink" title="基本准备工作"></a>基本准备工作</h3><p>先建一个项目</p><p>我们创建了add.js文件和minus.js文件,然后 在index.js中引入，再将index.js文件引入index.html。</p><p>代码如下:</p><p>add.js</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export default (<span class="selector-tag">a</span>,<span class="selector-tag">b</span>)=&gt;&#123;</span><br><span class="line">  return <span class="selector-tag">a</span>+<span class="selector-tag">b</span>;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure><p>minus.js</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export const minus = (<span class="selector-tag">a</span>,<span class="selector-tag">b</span>)=&gt;&#123;</span><br><span class="line">    return <span class="selector-tag">a</span>-<span class="selector-tag">b</span></span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure><p>index.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> add <span class="keyword">from</span> <span class="string">&quot;./add.js&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123;minus&#125; <span class="keyword">from</span> <span class="string">&quot;./minus.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sum = add(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">const</span> division = minus(<span class="number">2</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(sum);</span><br><span class="line"><span class="built_in">console</span>.log(division);</span><br></pre></td></tr></table></figure><p>index.html</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./src/index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure><p>现在我们打开index.html。你猜会发生什么？？？显然会报错，因为浏览器还不能识别import等ES6语法</p><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/7/24/1737e4428e16ee77~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" alt="img"></p><h3 id="获取主模块内容"><a href="#获取主模块内容" class="headerlink" title="获取主模块内容"></a>获取主模块内容</h3><p>bundle.js文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取主入口文件</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> getModuleInfo = <span class="function">(<span class="params">file</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> body = fs.readFileSync(file,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(body);</span><br><span class="line">&#125;</span><br><span class="line">getModuleInfo(<span class="string">&quot;./src/index.js&quot;</span>)</span><br></pre></td></tr></table></figure><p>执行一下bundle.js：<code>node bundle.js</code></p><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/7/24/1737e4428eab35af~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" alt="img"></p><h3 id="分析模块babel-parser"><a href="#分析模块babel-parser" class="headerlink" title="分析模块babel/parser"></a>分析模块babel/parser</h3><p>分析模块的主要任务是 将获取到的主模块内容 解析成AST语法树，这个需要用到一个依赖包@babel/parser</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @babel/parser</span><br></pre></td></tr></table></figure><p>ok,安装完成我们将@babel/parser引入bundle.js,</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取主入口文件</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">&#x27;@babel/parser&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> getModuleInfo = <span class="function">(<span class="params">file</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> body = fs.readFileSync(file,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="comment">// 新增代码</span></span><br><span class="line">    <span class="keyword">const</span> ast = parser.parse(body,&#123;</span><br><span class="line">        <span class="attr">sourceType</span>:<span class="string">&#x27;module&#x27;</span> <span class="comment">//表示我们要解析的是ES模块</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(ast);</span><br><span class="line"><span class="comment">//当前我们解析出来的不单单是index.js文件里的内容，它也包括了文件的其他信息。 而它的内容其实是它的属性program里的body里</span></span><br><span class="line">    <span class="built_in">console</span>.log(ast.program.body);</span><br><span class="line">&#125;</span><br><span class="line">getModuleInfo(<span class="string">&quot;./src/index.js&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="收集依赖babel-traverse"><a href="#收集依赖babel-traverse" class="headerlink" title="收集依赖babel/traverse"></a>收集依赖babel/traverse</h3><p>现在我们需要 遍历AST，将用到的依赖收集起来。什么意思呢？其实就是将用import语句引入的文件路径收集起来。我们将收集起来的路径放到deps里。</p><p>前面我们提到过，遍历AST要用到@babel/traverse依赖包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @babel/traverse</span><br></pre></td></tr></table></figure><p>现在，我们引入。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">&#x27;@babel/parser&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">&#x27;@babel/traverse&#x27;</span>).default</span><br><span class="line"><span class="keyword">const</span> getModuleInfo = <span class="function">(<span class="params">file</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> body = fs.readFileSync(file,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> ast = parser.parse(body,&#123;</span><br><span class="line">        <span class="attr">sourceType</span>:<span class="string">&#x27;module&#x27;</span> <span class="comment">//表示我们要解析的是ES模块</span></span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 新增代码</span></span><br><span class="line">    <span class="keyword">const</span> deps = &#123;&#125;</span><br><span class="line">    traverse(ast,&#123;</span><br><span class="line">         <span class="comment">//ImportDeclaration方法代表的是对ast中type类型为ImportDeclaration的节点的处理。</span></span><br><span class="line">        <span class="function"><span class="title">ImportDeclaration</span>(<span class="params">&#123;node&#125;</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">const</span> dirname = path.dirname(file)</span><br><span class="line">            <span class="keyword">const</span> abspath = <span class="string">&#x27;./&#x27;</span> + path.join(dirname,node.source.value)</span><br><span class="line">            deps[node.source.value] = abspath</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(deps);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">getModuleInfo(<span class="string">&quot;./src/index.js&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="ES6的AST转化成ES5"><a href="#ES6的AST转化成ES5" class="headerlink" title="ES6的AST转化成ES5"></a>ES6的AST转化成ES5</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @babel/core @babel/preset-env</span><br></pre></td></tr></table></figure><p>我们现在将依赖引入并使用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">&#x27;@babel/parser&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">&#x27;@babel/traverse&#x27;</span>).default</span><br><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">&#x27;@babel/core&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> getModuleInfo = <span class="function">(<span class="params">file</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> body = fs.readFileSync(file,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> ast = parser.parse(body,&#123;</span><br><span class="line">        <span class="attr">sourceType</span>:<span class="string">&#x27;module&#x27;</span> <span class="comment">//表示我们要解析的是ES模块</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> deps = &#123;&#125;</span><br><span class="line">    traverse(ast,&#123;</span><br><span class="line">        <span class="function"><span class="title">ImportDeclaration</span>(<span class="params">&#123;node&#125;</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">const</span> dirname = path.dirname(file)</span><br><span class="line">            <span class="keyword">const</span> abspath = <span class="string">&quot;./&quot;</span> + path.join(dirname,node.source.value)</span><br><span class="line">            deps[node.source.value] = abspath</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    新增代码</span><br><span class="line">    <span class="keyword">const</span> &#123;code&#125; = babel.transformFromAst(ast,<span class="literal">null</span>,&#123;</span><br><span class="line">        <span class="attr">presets</span>:[<span class="string">&quot;@babel/preset-env&quot;</span>]</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(code);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">getModuleInfo(<span class="string">&quot;./src/index.js&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="递归获取所有依赖"><a href="#递归获取所有依赖" class="headerlink" title="递归获取所有依赖"></a>递归获取所有依赖</h3><p>经过上面的过程，现在我们知道getModuleInfo是用来获取一个模块的内容，不过我们还没把获取的内容return出来，因此，更改下getModuleInfo方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getModuleInfo = <span class="function">(<span class="params">file</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> body = fs.readFileSync(file,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> ast = parser.parse(body,&#123;</span><br><span class="line">        <span class="attr">sourceType</span>:<span class="string">&#x27;module&#x27;</span> <span class="comment">//表示我们要解析的是ES模块</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> deps = &#123;&#125;</span><br><span class="line">    traverse(ast,&#123;</span><br><span class="line">        <span class="function"><span class="title">ImportDeclaration</span>(<span class="params">&#123;node&#125;</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">const</span> dirname = path.dirname(file)</span><br><span class="line">            <span class="keyword">const</span> abspath = <span class="string">&quot;./&quot;</span> + path.join(dirname,node.source.value)</span><br><span class="line">            deps[node.source.value] = abspath</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> &#123;code&#125; = babel.transformFromAst(ast,<span class="literal">null</span>,&#123;</span><br><span class="line">        <span class="attr">presets</span>:[<span class="string">&quot;@babel/preset-env&quot;</span>]</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 新增代码</span></span><br><span class="line">    <span class="keyword">const</span> moduleInfo = &#123;file,deps,code&#125;</span><br><span class="line">    <span class="keyword">return</span> moduleInfo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们返回了一个对象 ，这个对象包括<strong>主模块的路径（file）</strong>，<strong>主模块的依赖（deps）</strong>，<strong>主模块转化成es5的代码</strong></p><p>该方法只能获取一个模块的的信息，但是我们要怎么获取一个模块里面的依赖模块的信息呢？递归。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//递归获取依赖</span><br><span class="line">const parseModules = (file) =&gt;&#123;</span><br><span class="line">    const entry =  getModuleInfo(file)</span><br><span class="line">    const temp = [entry]</span><br><span class="line">    for (let i = 0;i&lt;temp.length;i++)&#123;</span><br><span class="line">        const deps = temp[i].deps</span><br><span class="line">        if (deps)&#123;</span><br><span class="line">            for (const key in deps)&#123;</span><br><span class="line">                if (deps.hasOwnProperty(key))&#123;</span><br><span class="line">                    temp.push(getModuleInfo(deps[key]))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    console.log(temp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>讲解下parseModules方法：</p><ol><li>我们首先传入主模块路径</li><li>将获得的模块信息放到temp数组里。</li><li>外面的循坏遍历temp数组，此时的temp数组只有主模块</li><li>循环里面再获得主模块的依赖deps</li><li>遍历deps，通过调用getModuleInfo将获得的依赖模块信息push到temp数组里。</li></ol><p>按照目前我们的项目来说执行完，应当是temp 应当是存放了index.js,add.js,minus.js三个模块。 ,执行看看。</p><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/7/24/1737e442e4a822fc~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" alt="img"></p><p>不过现在的temp数组里的对象格式不利于后面的操作，我们希望是以文件的路径为key，{code，deps}为值的形式存储。因此，我们创建一个新的对象depsGraph。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> parseModules = <span class="function">(<span class="params">file</span>) =&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> entry =  getModuleInfo(file)</span><br><span class="line">    <span class="keyword">const</span> temp = [entry] </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>;i&lt;temp.length;i++)&#123;</span><br><span class="line">        <span class="keyword">const</span> deps = temp[i].deps</span><br><span class="line">        <span class="keyword">if</span> (deps)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> deps)&#123;</span><br><span class="line">                <span class="keyword">if</span> (deps.hasOwnProperty(key))&#123;</span><br><span class="line">                    temp.push(getModuleInfo(deps[key]))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 新增代码</span></span><br><span class="line">    <span class="keyword">const</span> depsGraph = &#123;&#125;</span><br><span class="line">    temp.forEach(<span class="function"><span class="params">moduleInfo</span>=&gt;</span>&#123;</span><br><span class="line">        depsGraph[moduleInfo.file] = &#123;</span><br><span class="line">            <span class="attr">deps</span>:moduleInfo.deps,</span><br><span class="line">            <span class="attr">code</span>:moduleInfo.code</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(depsGraph)</span><br><span class="line">    <span class="keyword">return</span> depsGraph</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/7/24/1737e442ed76d596~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.awebp" alt="img"></p><h3 id="导入导出"><a href="#导入导出" class="headerlink" title="导入导出"></a>导入导出</h3><p>我们现在的目的就是要生成一个bundle.js文件，也就是打包后的一个文件。其实思路很简单，就是把index.js的内容和它的依赖模块整合起来。然后把代码写到一个新建的js文件。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span></span><br><span class="line"><span class="keyword">var</span> _add = _interopRequireDefault(<span class="built_in">require</span>(<span class="string">&quot;./add.js&quot;</span>));</span><br><span class="line"><span class="keyword">var</span> _minus = <span class="built_in">require</span>(<span class="string">&quot;./minus.js&quot;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_interopRequireDefault</span>(<span class="params">obj</span>) </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">  <span class="keyword">return</span> obj &amp;&amp; obj.__esModule ? obj : &#123; <span class="string">&quot;default&quot;</span>: obj &#125;; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> sum = (<span class="number">0</span>, _add[<span class="string">&quot;default&quot;</span>])(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">var</span> division = (<span class="number">0</span>, _minus.minus)(<span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line"><span class="built_in">console</span>.log(sum); <span class="built_in">console</span>.log(division);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add.js</span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(<span class="built_in">exports</span>, <span class="string">&quot;__esModule&quot;</span>, &#123;  <span class="attr">value</span>: <span class="literal">true</span>&#125;);</span><br><span class="line"><span class="built_in">exports</span>[<span class="string">&quot;default&quot;</span>] = <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> _default = <span class="function"><span class="keyword">function</span> <span class="title">_default</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b;&#125;;</span><br><span class="line"><span class="built_in">exports</span>[<span class="string">&quot;default&quot;</span>] = _default;</span><br></pre></td></tr></table></figure><p>但是我们现在是不能执行index.js这段代码的，因为浏览器不会识别执行require和exports。</p><p>不能识别是为什么？因为没有定义这<strong>require函数，和exports对象</strong>。那我们可以自己定义。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bundle = <span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//返回一个整合完整的字符串代码</span></span><br><span class="line">  <span class="keyword">const</span> depsGraph = <span class="built_in">JSON</span>.stringify(parseModules(file)); </span><br><span class="line">  <span class="built_in">console</span>.log(depsGraph);</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 把保存下来的depsGraph，传入一个立即执行函数。</span></span><br><span class="line"><span class="comment">    将主模块路径传入require函数执行</span></span><br><span class="line"><span class="comment">    执行reuire函数的时候，又立即执行一个立即执行函数，这里是把code的值传进去了</span></span><br><span class="line"><span class="comment">    执行eval（code）。也就是执行主模块的code这段代码</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">`(function (graph) &#123;</span></span><br><span class="line"><span class="string">    function require(file) &#123;</span></span><br><span class="line"><span class="string">      //转化成绝对路径</span></span><br><span class="line"><span class="string">      function absRequire(relPath) &#123;</span></span><br><span class="line"><span class="string">        return require(graph[file].deps[relPath])</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      //执行add.js的code时候，会遇到exports这个还没定义的问题.因此我们可以自己定义一个exports对象。</span></span><br><span class="line"><span class="string">      var exports = &#123;&#125;;</span></span><br><span class="line"><span class="string">      (function (require, exports, code) &#123;</span></span><br><span class="line"><span class="string">        console.log(1, exports);</span></span><br><span class="line"><span class="string">        //code代码执行过程中会执行到require函数。</span></span><br><span class="line"><span class="string">        //这时会调用这个require，也就是我们传入的absRequire</span></span><br><span class="line"><span class="string">        eval(code);</span></span><br><span class="line"><span class="string">      &#125;)(absRequire, exports, graph[file].code)</span></span><br><span class="line"><span class="string">      return exports;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    require(&#x27;<span class="subst">$&#123;file&#125;</span>&#x27;)</span></span><br><span class="line"><span class="string">  &#125;)(<span class="subst">$&#123;depsGraph&#125;</span>)`</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> content = bundle(<span class="string">&quot;./src/index.js&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li><p>把保存下来的depsGraph，传入一个立即执行函数。</p><ul><li><p>将主模块路径传入require函数执行</p><ul><li><p>reuire函数中立即执行函数</p><ul><li><p>require：absRequire，因为code代码中require路径不是绝对路径，需要转化成绝对路径，因此写一个函数absRequire来转化</p></li><li><p>exports：exports</p><ul><li><p>增添了一个空对象 exports，执行add.js代码的时候，会往这个空对象上增加一些属性</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add.js</span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(<span class="built_in">exports</span>, <span class="string">&quot;__esModule&quot;</span>, &#123; <span class="attr">value</span>: <span class="literal">true</span>&#125;);</span><br><span class="line"><span class="built_in">exports</span>[<span class="string">&quot;default&quot;</span>] = <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> _default = <span class="function"><span class="keyword">function</span> <span class="title">_default</span>(<span class="params">a, b</span>) </span>&#123;  <span class="keyword">return</span> a + b;&#125;;</span><br><span class="line"><span class="built_in">exports</span>[<span class="string">&quot;default&quot;</span>] = _default;</span><br><span class="line"><span class="comment">//执行完这段代码后</span></span><br><span class="line"><span class="built_in">exports</span> = &#123;</span><br><span class="line">  __esModule：&#123;  <span class="attr">value</span>: <span class="literal">true</span>&#125;，</span><br><span class="line">  <span class="keyword">default</span>：<span class="function"><span class="keyword">function</span> <span class="title">_default</span>(<span class="params">a, b</span>) </span>&#123;  <span class="keyword">return</span> a + b;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>然后我们把exports对象return出去。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _add = _interopRequireDefault(<span class="built_in">require</span>(<span class="string">&quot;./add.js&quot;</span>));</span><br></pre></td></tr></table></figure><p>return出去的值，被_interopRequireDefault接收，_interopRequireDefault再返回default这个属性给_add，因此<code>_add = function _default(a, b) &#123; return a + b;&#125;</code></p></li></ul></li><li><p>code：graph[file].code</p><ul><li>执行eval（code）,也就是执行模块的code这段代码<ul><li>执行eval（code）过程会执行到require函数，这时会调用这个require，也就是我们传入的absRequire，而执行absRequire就执行了<code>return require(graph[file].deps[relPath])</code>这段代码，也就是执行了外面这个require。而执行require（”./src/add.js”）之后，又会执行eval，也就是执行add.js文件的代码。</li></ul></li></ul></li></ul></li></ul></li></ul></li></ul><h2 id="Sourcemap"><a href="#Sourcemap" class="headerlink" title="Sourcemap"></a>Sourcemap</h2><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/g5GcZ10G89Xb9hZ1SibVrA">https://mp.weixin.qq.com/s/g5GcZ10G89Xb9hZ1SibVrA</a></p><p><strong><code>Sourcemap</code> 本质上是一个信息文件（储存着代码转换前后的对应位置信息），关联编译后的代码和源码的，通过一个个行列号的映射。</strong>比如编译后代码的第 3 行第 4 列，对应着源码里的第 8 行第 5 列这种，这叫做一个mapping。简单说 <code>Sourcemap</code> 构建了处理前以及处理后的代码之间的一座桥梁，方便定位生产环境中出现 <code>bug</code> 的位置。</p><p>sourcemap 的格式如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    version : 3,</span><br><span class="line">    file: &quot;out.js&quot;,</span><br><span class="line">    sourceRoot : &quot;&quot;,</span><br><span class="line">    sources: [&quot;foo.js&quot;, &quot;bar.js&quot;],</span><br><span class="line">    names: [&quot;a&quot;, &quot;b&quot;],</span><br><span class="line">    mappings: &quot;AAgBC,SAAQ,CAAEA;AAAEA&quot;,</span><br><span class="line">    sourcesContent: [&#x27;const a = 1; console.log(a)&#x27;, &#x27;const b = 2; console.log(b)&#x27;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>version 是版本号，file 是文件名，sourceRoot 是源码根目录，names 是转换前的变量名，sources 是源码文件，sourcesContent 是每个 sources 对应的源码的内容，mappings 就是一个个位置映射了。</p><p><strong>为什么 sources 可以有多个呢？</strong></p><p>因为可能编译产物是多个源文件合并的，比如打包，一个 bundle.js 就对应了 n 个 sources 源文件。</p><p><strong>为什么要把变量名单独摘出来到 names 里呢？</strong></p><p>因为这样就可以通过下标来索引了，mapping 里面就不用保存变量名，只保留 names 的索引就行。</p><p><strong>重点是 mappings 部分：</strong></p><p>mappings 部分是通过分号<code>;</code> 和逗号 <code>,</code> 分隔的：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mappings:&quot;AAAAA,BBBBB;CCCCC&quot;</span><br></pre></td></tr></table></figure><p>一个分号就代表一行，这样就免去了行的映射。</p><p>然后每一行可能有多个位置的映射，用 <code>,</code> 分隔</p><p>那具体的每一个 mapping 都是啥呢？</p><p>比如 AAAAA 一共五位，分别有不同的含义：</p><ul><li>第一位：转换后代码的第几列（行数通过分号 ; 来确定）</li><li>第二位：对应转换前的哪个源码文件，保存在 sources 里的，这里通过下标索引</li><li>第三位：对应转换前的源码的第几行</li><li>第四位：对应转换前的源码的第几列</li><li>第五位：对应转换前的源码的哪个变量名，保存在 names 里的，这里通过下标索引</li></ul><h3 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h3><ul><li>eval：浏览器 devtool 支持通过 sourceUrl 来把 eval 的内容单独生成文件，还可以进一步通过 sourceMappingUrl 来映射回源码，webpack 利用这个特性来简化了 sourcemap 的处理，可以直接从模块开始映射，不用从 bundle 级别。</li><li>cheap：只映射到源代码的某一行，不精确到列，可以提升 sourcemap 生成速度</li><li>source-map：生成 sourcemap 文件，可以配置 inline，会以 dataURL 的方式内联，可以配置 hidden，只生成 sourcemap，不和生成的文件关联。</li><li>nosources：不生成 sourceContent 内容，可以减小 sourcemap 文件的大小</li><li>module：sourcemap 生成时会关联每一步 loader 生成的 sourcemap，配合 sourcemap-loader 可以映射回最初的源码</li></ul><p>理解了这些基础配置项，根据 ^(inline-|hidden-|eval-)?(nosources-)?(cheap-(module-)?)?source-map$ 的规律来进行组合，就可以实现各种需求下的 sourcemap 配置。</p><p>当然，这种 sourcemap 配置还不够细致，比如 sourcemap 的 url 怎么生成，文件名是什么。如果想对这些做配置，可以关掉 devtool，启用 SourceMapDevToolPlugin 来配置。</p><p>虽然 webapck 的 sourcemap 配置方式比较多，但最底层也就是浏览器支持的文件级别的 sourcemap 还有 eval 代码的 source 映射和 sourcemap 这两种机制。其余的方式都是基于这两种机制的封装。</p><h1 id="单应用框架"><a href="#单应用框架" class="headerlink" title="单应用框架"></a>单应用框架</h1><h2 id="软件架构模式"><a href="#软件架构模式" class="headerlink" title="软件架构模式"></a>软件架构模式</h2><p><a target="_blank" rel="noopener" href="https://www.pianshen.com/article/3716256399/">https://www.pianshen.com/article/3716256399/</a></p><p>MVC，MVP和MVVM都是常见的<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:2396493957%7D">软件架构设计模式</a>（Architectural Pattern），它通过分离关注点来改进代码的组织方式。它们目标都是解耦，解耦好处一个是关注点分离，提升代码可维护和可读性，并且提升代码复用性。</p><h3 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h3><p>MVC全名是Model View Controller，是模型(model)－视图(view)－控制器(controller)的缩写，一种软件设计典范，用一种业务逻辑、数据、界面显示分离的软件设计规范。</p><ul><li><p><strong>Model（模型）</strong> ：数据层。将js的ajax当做Model，也就是数据层，通过ajax从服务器获取数据。</p></li><li><p><strong>View（视图）</strong> ：视图层。</p></li><li><p><strong>Controller（控制器）</strong>：交互层。用户对View的操作交给了Controller处理，在Controller中响应View的事件调用Model的接口对数据进行操作，一旦Model发生变化便通知相关视图进行更新</p></li></ul><p><img src="https://pics7.baidu.com/feed/8ad4b31c8701a18b40c30015c909c8002838fe6b.png@f_auto?token=e2763c67fdda4b27897e546b2a2b2367" alt="img"></p><blockquote><p>1.View传送指令到Controller。</p><p>2.Controller完成业务逻辑后改变Model状态。</p><p>3.Model将新的数据发送至View,用户得到反馈。</p></blockquote><p><strong>缺点</strong></p><p><strong>1.m层和v层直接打交道，导致这两层耦合度高</strong></p><p><strong>2.因为所有逻辑都写在c层，导致c层特别臃肿</strong></p><p>控制div是否显示：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;box&quot;</span>&gt;</span>我显示的<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>点击<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">        btn.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span>(box.style.display === <span class="string">&#x27;none&#x27;</span>) box.style.display = <span class="string">&#x27;block&#x27;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">else</span> box.style.display = <span class="string">&#x27;none&#x27;</span>;</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure><p>用数据驱动模型模型来写：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;box&quot;</span>&gt;</span>我显示的<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>点击<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span></span><br><span class="line"><span class="javascript"><span class="xml">        <span class="keyword">let</span> is_shown = <span class="literal">true</span>;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">el, is_shown</span>) </span>&#123;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">            <span class="keyword">if</span>(is_shown) el.style.display = <span class="string">&#x27;block&#x27;</span>;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">            <span class="keyword">else</span> el.style.display = <span class="string">&#x27;none&#x27;</span>;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        &#125;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        btn.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">            is_shown = !is_shown;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">            render(box, is_shown);</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        &#125;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure><p>看起来好像多了几行代码，但是对于第二种代码来说，简单抽象封装了 <code>render</code> 函数，我们只需要修改 <code>is_shown</code> 的 <code>bool</code> 值，而无需在意 <code>render</code> 函数内部的执行，就可以实现通过数据修改来驱动视图的更新。</p><h3 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h3><p>mvc中Controller演变成mvvm中的viewModel。 <strong>mvvm主要解决了mvc中大量DOM操作使页面首次渲染性能降低，加载速度变慢的问题 。</strong></p><p><strong>Model-View-ViewModel</strong>即模型-视图-视图模型。</p><ul><li><p>模型：数据层。后端传递的数据。</p></li><li><p>视图：视图层。</p></li><li><p>视图模型：mvvm模式的核心，它是连接view和model的桥梁。</p></li></ul><p><strong>总结</strong>：<strong>在MVVM的框架下视图和模型是不能直接通信的</strong>。它们通过ViewModel来通信，ViewModel通常要实现一个observer观察者，当数据发生变化，ViewModel能够监听到数据的这种变化，然后通知到对应的视图做自动更新，而当用户操作视图，ViewModel也能监听到视图的变化，然后通知数据做改动，这实际上就实现了数据的<strong>双向绑定</strong>。</p><h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><ul><li><p>dom操作方式</p><ul><li>MVC来讲，MVC操作的是真实dom，对于数据的更新需要找到对应抽象类来直接操作真实dom</li><li>对于MVVM来讲，它操作的是虚拟dom、<strong>在数据的更新后，该框架重新生成一个虚拟dom树，与旧虚拟dom树进行比对，然后替换修改的地方，所以可以将渲染视图抽象成一个函数类</strong></li></ul></li><li><p>视图更新</p><ul><li>MVVM完全不需要考虑视图更新对dom树的操作，框架会自动响应绑定对视图的更新</li></ul></li><li><p>性能</p><ul><li>页面首次渲染，MVVM框架可能会比MVC框架快一些，因为MVVM只会进行一次对真实dom的操作，而MVC可能会进行多次真实dom的操作</li><li>在首屏渲染完毕后，用户开始对页面进行直接操作时，MVVM的性能肯定会输MVC的<ul><li>对于MVC构建的页面来说，用户修改数据，该框架会根据绑定的dom元素直接进行修改</li><li>而对于MVVM构建的页面来说，用户修改数据，该框架会重新生成虚拟dom树与原树进行比对，再修改</li><li>虽然可以进行diff（新旧虚拟dom树比对算法）优化，但是一个是直接操作，一个需要最少O(n)算法比对在进行真实dom操作</li></ul></li></ul></li><li><p>框架</p><ul><li>常见的MVC框架有：Angular.js</li></ul></li></ul><h2 id="框架对比"><a href="#框架对比" class="headerlink" title="框架对比"></a>框架对比</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903974437388295">https://juejin.cn/post/6844903974437388295</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/100228073">https://zhuanlan.zhihu.com/p/100228073</a></p><h3 id="渐进式"><a href="#渐进式" class="headerlink" title="渐进式"></a>渐进式</h3><p>我们可以通过添加组件系统（components）、客户端路由（vue-router）、大规模状态管理（vuex）来构建一个完整的框架，这都是可选的</p><h3 id="开发团队"><a href="#开发团队" class="headerlink" title="开发团队"></a>开发团队</h3><ul><li>React是由FaceBook前端官方团队进行维护和更新的；因此，React的维护开发团队，技术实力比较雄厚；</li><li>Vue：第一版，主要是有作者 尤雨溪 专门进行维护的，当 Vue更新到 2.x 版本后，也有了一个小团队进行相关的维护和开发；</li></ul><h3 id="编写语法"><a href="#编写语法" class="headerlink" title="编写语法"></a>编写语法</h3><h4 id="vue"><a href="#vue" class="headerlink" title="vue"></a>vue</h4><p>vue推荐的做法是webpack+vue-loader的单文件组件格式，<strong>vue保留了html、css、js分离的写法</strong>，使得现有的前端开发者在开发的时候能保持原有的习惯，更接近常用的web开发方式，模板就是普通的html，数据绑定使用mustache风格，样式直接使用css。其中</p><style></style><script data-pjax>function electric_clock_injector_config(){var e=document.getElementsByClassName("sticky_layout")[0];console.log("已挂载electric_clock"),e.insertAdjacentHTML("afterbegin","undefined")}document.getElementsByClassName("sticky_layout")[0]&&(location.pathname,1)&&electric_clock_injector_config()</script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-electric-clock@1.0.6/clock.js"></script><script data-pjax>function butterfly_clock_anzhiyu_injector_config(){var e=document.getElementsByClassName("sticky_layout")[0];console.log("已挂载butterfly_clock_anzhiyu"),e&&e.insertAdjacentHTML("afterbegin",'<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",qweather_key="b16a1fa0e63c46a4b8f28abfb06ae3fe",gaud_map_key="20e4a5b832b5f4649f41ffc0a68c8c16# 高得地图web服务key",baidu_ak_key="undefined",flag=0,clock_rectangle="112.982279,28.19409",clock_default_rectangle_enable="false",i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;"all"===epage&&0==flag?butterfly_clock_anzhiyu_injector_config():epage===cpage&&butterfly_clock_anzhiyu_injector_config()</script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script></article></div></main></div></body></html>